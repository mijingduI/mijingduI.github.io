<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JUC - 共享模式之锁进阶 | 阿星 精神时の屋</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <script>var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?14366b81d7983944862ae088864b209e"; 
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
          </script>
    <meta name="description" content="互联网技术博客，包含Java、C#、Golang、易语言、游戏逆向、汇编等技术文章。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="互联网技术博客，包含Java、C#、Golang、易语言、游戏逆向、汇编等技术文章。">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.75a488ab.css" as="style"><link rel="preload" href="/assets/js/app.e9152798.js" as="script"><link rel="preload" href="/assets/js/2.38a2c275.js" as="script"><link rel="preload" href="/assets/js/84.e2702905.js" as="script"><link rel="preload" href="/assets/js/7.c9d16a87.js" as="script"><link rel="preload" href="/assets/js/4.d198576f.js" as="script"><link rel="prefetch" href="/assets/js/10.188eb72a.js"><link rel="prefetch" href="/assets/js/100.5dd5864c.js"><link rel="prefetch" href="/assets/js/101.4e3ae8ef.js"><link rel="prefetch" href="/assets/js/102.4beee255.js"><link rel="prefetch" href="/assets/js/103.28dc5d01.js"><link rel="prefetch" href="/assets/js/104.ada74d0f.js"><link rel="prefetch" href="/assets/js/105.8eaccbe2.js"><link rel="prefetch" href="/assets/js/106.7190986d.js"><link rel="prefetch" href="/assets/js/107.9547df04.js"><link rel="prefetch" href="/assets/js/108.ca558947.js"><link rel="prefetch" href="/assets/js/109.68f1c70f.js"><link rel="prefetch" href="/assets/js/11.335552b4.js"><link rel="prefetch" href="/assets/js/110.e9af8e71.js"><link rel="prefetch" href="/assets/js/111.bbd64e4e.js"><link rel="prefetch" href="/assets/js/112.54dce4bf.js"><link rel="prefetch" href="/assets/js/113.33ef30e5.js"><link rel="prefetch" href="/assets/js/114.3217c260.js"><link rel="prefetch" href="/assets/js/115.95735873.js"><link rel="prefetch" href="/assets/js/116.ab6d0147.js"><link rel="prefetch" href="/assets/js/117.3e83abb1.js"><link rel="prefetch" href="/assets/js/118.143549c0.js"><link rel="prefetch" href="/assets/js/119.b8c9747e.js"><link rel="prefetch" href="/assets/js/12.9e8e1698.js"><link rel="prefetch" href="/assets/js/120.d4930414.js"><link rel="prefetch" href="/assets/js/121.9ba52a17.js"><link rel="prefetch" href="/assets/js/122.3a0490cc.js"><link rel="prefetch" href="/assets/js/123.b10f79af.js"><link rel="prefetch" href="/assets/js/124.6d12a686.js"><link rel="prefetch" href="/assets/js/125.c264fb08.js"><link rel="prefetch" href="/assets/js/126.1c983a31.js"><link rel="prefetch" href="/assets/js/127.d1577a05.js"><link rel="prefetch" href="/assets/js/128.5cfbad57.js"><link rel="prefetch" href="/assets/js/129.73d15fd6.js"><link rel="prefetch" href="/assets/js/13.a5c701e0.js"><link rel="prefetch" href="/assets/js/130.a17b91c3.js"><link rel="prefetch" href="/assets/js/131.60f6e361.js"><link rel="prefetch" href="/assets/js/132.d4a09396.js"><link rel="prefetch" href="/assets/js/133.0def91c2.js"><link rel="prefetch" href="/assets/js/134.713218a7.js"><link rel="prefetch" href="/assets/js/135.1e75aa3e.js"><link rel="prefetch" href="/assets/js/136.36cacecd.js"><link rel="prefetch" href="/assets/js/137.e51c0df9.js"><link rel="prefetch" href="/assets/js/138.8fd13027.js"><link rel="prefetch" href="/assets/js/139.6cb39d71.js"><link rel="prefetch" href="/assets/js/14.cb636573.js"><link rel="prefetch" href="/assets/js/140.a4732878.js"><link rel="prefetch" href="/assets/js/141.052cefb6.js"><link rel="prefetch" href="/assets/js/142.138f52c3.js"><link rel="prefetch" href="/assets/js/143.e75ee230.js"><link rel="prefetch" href="/assets/js/144.c4c9cc1c.js"><link rel="prefetch" href="/assets/js/145.3e138bee.js"><link rel="prefetch" href="/assets/js/146.8e4442a9.js"><link rel="prefetch" href="/assets/js/147.1ae072cd.js"><link rel="prefetch" href="/assets/js/148.95efc83f.js"><link rel="prefetch" href="/assets/js/149.1e9796e3.js"><link rel="prefetch" href="/assets/js/15.4909b854.js"><link rel="prefetch" href="/assets/js/150.121caebf.js"><link rel="prefetch" href="/assets/js/151.7ecc8f09.js"><link rel="prefetch" href="/assets/js/152.a349fc5e.js"><link rel="prefetch" href="/assets/js/153.38939649.js"><link rel="prefetch" href="/assets/js/154.fff7dc02.js"><link rel="prefetch" href="/assets/js/155.f8044b4b.js"><link rel="prefetch" href="/assets/js/156.2c8d83e3.js"><link rel="prefetch" href="/assets/js/157.4bb24015.js"><link rel="prefetch" href="/assets/js/158.39a55d83.js"><link rel="prefetch" href="/assets/js/159.888dd121.js"><link rel="prefetch" href="/assets/js/16.9bd34245.js"><link rel="prefetch" href="/assets/js/160.59bfcd50.js"><link rel="prefetch" href="/assets/js/161.73e1bd1c.js"><link rel="prefetch" href="/assets/js/162.13987fb3.js"><link rel="prefetch" href="/assets/js/163.e0fc4fd3.js"><link rel="prefetch" href="/assets/js/164.c536e9ed.js"><link rel="prefetch" href="/assets/js/165.b1e9188c.js"><link rel="prefetch" href="/assets/js/166.24aa8377.js"><link rel="prefetch" href="/assets/js/167.cb791f87.js"><link rel="prefetch" href="/assets/js/168.f60e3695.js"><link rel="prefetch" href="/assets/js/169.bdc0920c.js"><link rel="prefetch" href="/assets/js/17.385cde94.js"><link rel="prefetch" href="/assets/js/170.c5c97354.js"><link rel="prefetch" href="/assets/js/171.7b1ad789.js"><link rel="prefetch" href="/assets/js/172.b5a5df41.js"><link rel="prefetch" href="/assets/js/173.b0798630.js"><link rel="prefetch" href="/assets/js/174.c1199fb7.js"><link rel="prefetch" href="/assets/js/175.bc298342.js"><link rel="prefetch" href="/assets/js/176.e023c386.js"><link rel="prefetch" href="/assets/js/177.3365eb85.js"><link rel="prefetch" href="/assets/js/178.1c812235.js"><link rel="prefetch" href="/assets/js/179.7a4ef255.js"><link rel="prefetch" href="/assets/js/18.242106a1.js"><link rel="prefetch" href="/assets/js/180.34710608.js"><link rel="prefetch" href="/assets/js/181.8d2ffc10.js"><link rel="prefetch" href="/assets/js/182.3dfc16b1.js"><link rel="prefetch" href="/assets/js/183.d7a6857a.js"><link rel="prefetch" href="/assets/js/184.59ad8234.js"><link rel="prefetch" href="/assets/js/185.0ad88aa7.js"><link rel="prefetch" href="/assets/js/186.c17df066.js"><link rel="prefetch" href="/assets/js/187.c2a823f3.js"><link rel="prefetch" href="/assets/js/188.4272caff.js"><link rel="prefetch" href="/assets/js/189.1682354f.js"><link rel="prefetch" href="/assets/js/19.592d8e57.js"><link rel="prefetch" href="/assets/js/190.d4c8afd6.js"><link rel="prefetch" href="/assets/js/191.34bbcd9b.js"><link rel="prefetch" href="/assets/js/192.50b6aac6.js"><link rel="prefetch" href="/assets/js/193.c7043b73.js"><link rel="prefetch" href="/assets/js/194.acf3fdd2.js"><link rel="prefetch" href="/assets/js/195.6b7b6802.js"><link rel="prefetch" href="/assets/js/196.60f3dbe1.js"><link rel="prefetch" href="/assets/js/197.3acb436b.js"><link rel="prefetch" href="/assets/js/198.0edf86fa.js"><link rel="prefetch" href="/assets/js/199.79ba8542.js"><link rel="prefetch" href="/assets/js/20.c5b342f8.js"><link rel="prefetch" href="/assets/js/200.f95afe9f.js"><link rel="prefetch" href="/assets/js/201.cb512539.js"><link rel="prefetch" href="/assets/js/202.fcf25066.js"><link rel="prefetch" href="/assets/js/203.a43c73df.js"><link rel="prefetch" href="/assets/js/204.2395aec2.js"><link rel="prefetch" href="/assets/js/205.76273eca.js"><link rel="prefetch" href="/assets/js/206.d1d16e48.js"><link rel="prefetch" href="/assets/js/207.ae9e7e12.js"><link rel="prefetch" href="/assets/js/208.c6c57b6e.js"><link rel="prefetch" href="/assets/js/209.1f0f043b.js"><link rel="prefetch" href="/assets/js/21.f810eaa2.js"><link rel="prefetch" href="/assets/js/210.39003b35.js"><link rel="prefetch" href="/assets/js/211.7dab8ad2.js"><link rel="prefetch" href="/assets/js/212.2bf95f75.js"><link rel="prefetch" href="/assets/js/213.52a71825.js"><link rel="prefetch" href="/assets/js/214.101e6174.js"><link rel="prefetch" href="/assets/js/215.7c6c20c7.js"><link rel="prefetch" href="/assets/js/216.bb59f914.js"><link rel="prefetch" href="/assets/js/217.92d5cf38.js"><link rel="prefetch" href="/assets/js/218.ab7fb4bd.js"><link rel="prefetch" href="/assets/js/219.95f6dd29.js"><link rel="prefetch" href="/assets/js/22.f79c22a0.js"><link rel="prefetch" href="/assets/js/220.f894549c.js"><link rel="prefetch" href="/assets/js/221.03d7c6c1.js"><link rel="prefetch" href="/assets/js/222.bb84da56.js"><link rel="prefetch" href="/assets/js/223.844d9b99.js"><link rel="prefetch" href="/assets/js/224.b2e9cf83.js"><link rel="prefetch" href="/assets/js/225.3c2dc558.js"><link rel="prefetch" href="/assets/js/226.9357ddd7.js"><link rel="prefetch" href="/assets/js/227.a14c09d8.js"><link rel="prefetch" href="/assets/js/228.290bdd8c.js"><link rel="prefetch" href="/assets/js/229.1fdbf5dc.js"><link rel="prefetch" href="/assets/js/23.7ae5086b.js"><link rel="prefetch" href="/assets/js/230.9cc51fad.js"><link rel="prefetch" href="/assets/js/231.731d246e.js"><link rel="prefetch" href="/assets/js/232.bd57162f.js"><link rel="prefetch" href="/assets/js/233.66c7c8a1.js"><link rel="prefetch" href="/assets/js/234.b8996b84.js"><link rel="prefetch" href="/assets/js/235.a06c178e.js"><link rel="prefetch" href="/assets/js/236.c35748b3.js"><link rel="prefetch" href="/assets/js/237.e6470d9e.js"><link rel="prefetch" href="/assets/js/238.89d583c7.js"><link rel="prefetch" href="/assets/js/239.2c644998.js"><link rel="prefetch" href="/assets/js/24.d3c496f5.js"><link rel="prefetch" href="/assets/js/240.2a9203e9.js"><link rel="prefetch" href="/assets/js/241.9ae55de2.js"><link rel="prefetch" href="/assets/js/242.72dda6c8.js"><link rel="prefetch" href="/assets/js/243.f3db2bca.js"><link rel="prefetch" href="/assets/js/244.4de3712a.js"><link rel="prefetch" href="/assets/js/245.0c623b7f.js"><link rel="prefetch" href="/assets/js/246.96d8f766.js"><link rel="prefetch" href="/assets/js/247.9bc7bb14.js"><link rel="prefetch" href="/assets/js/248.e0d71e3c.js"><link rel="prefetch" href="/assets/js/249.f205c474.js"><link rel="prefetch" href="/assets/js/25.aeffe170.js"><link rel="prefetch" href="/assets/js/250.e0b89c71.js"><link rel="prefetch" href="/assets/js/251.0a1dff82.js"><link rel="prefetch" href="/assets/js/252.0a2b1abf.js"><link rel="prefetch" href="/assets/js/253.75a66718.js"><link rel="prefetch" href="/assets/js/254.bac91309.js"><link rel="prefetch" href="/assets/js/255.4585deb2.js"><link rel="prefetch" href="/assets/js/256.e7119f59.js"><link rel="prefetch" href="/assets/js/257.c0844f83.js"><link rel="prefetch" href="/assets/js/258.c3cbb48e.js"><link rel="prefetch" href="/assets/js/259.af363aa7.js"><link rel="prefetch" href="/assets/js/26.235ea87a.js"><link rel="prefetch" href="/assets/js/260.9eecea0c.js"><link rel="prefetch" href="/assets/js/261.e61db71d.js"><link rel="prefetch" href="/assets/js/262.a5fa270f.js"><link rel="prefetch" href="/assets/js/263.437c94dc.js"><link rel="prefetch" href="/assets/js/264.0771677a.js"><link rel="prefetch" href="/assets/js/265.dac3ac33.js"><link rel="prefetch" href="/assets/js/266.493e5e67.js"><link rel="prefetch" href="/assets/js/267.c9b6b010.js"><link rel="prefetch" href="/assets/js/268.fd068824.js"><link rel="prefetch" href="/assets/js/269.6bed8d16.js"><link rel="prefetch" href="/assets/js/27.37ef57c6.js"><link rel="prefetch" href="/assets/js/270.9594bb9d.js"><link rel="prefetch" href="/assets/js/271.b67fc343.js"><link rel="prefetch" href="/assets/js/272.b6799f68.js"><link rel="prefetch" href="/assets/js/273.c5720146.js"><link rel="prefetch" href="/assets/js/274.92a3c1a1.js"><link rel="prefetch" href="/assets/js/275.94bead6d.js"><link rel="prefetch" href="/assets/js/276.4f8cc7d1.js"><link rel="prefetch" href="/assets/js/277.8c3a980a.js"><link rel="prefetch" href="/assets/js/278.82591e99.js"><link rel="prefetch" href="/assets/js/279.4169aeaf.js"><link rel="prefetch" href="/assets/js/28.b5a6c86a.js"><link rel="prefetch" href="/assets/js/280.c8c9ae49.js"><link rel="prefetch" href="/assets/js/281.9a7a4d55.js"><link rel="prefetch" href="/assets/js/282.b74debdd.js"><link rel="prefetch" href="/assets/js/283.63125d5f.js"><link rel="prefetch" href="/assets/js/284.cadc5e1d.js"><link rel="prefetch" href="/assets/js/285.91c1995c.js"><link rel="prefetch" href="/assets/js/286.0de78930.js"><link rel="prefetch" href="/assets/js/287.e73a0c86.js"><link rel="prefetch" href="/assets/js/288.d4c26769.js"><link rel="prefetch" href="/assets/js/289.64c3d5d2.js"><link rel="prefetch" href="/assets/js/29.c8256ce2.js"><link rel="prefetch" href="/assets/js/290.d2e46752.js"><link rel="prefetch" href="/assets/js/291.040773d1.js"><link rel="prefetch" href="/assets/js/292.e32af36d.js"><link rel="prefetch" href="/assets/js/293.ca50ac07.js"><link rel="prefetch" href="/assets/js/294.62f2a9ca.js"><link rel="prefetch" href="/assets/js/295.2b5d7273.js"><link rel="prefetch" href="/assets/js/296.babff4c2.js"><link rel="prefetch" href="/assets/js/297.9708d68c.js"><link rel="prefetch" href="/assets/js/298.44118eb8.js"><link rel="prefetch" href="/assets/js/299.819e1a17.js"><link rel="prefetch" href="/assets/js/3.98944d99.js"><link rel="prefetch" href="/assets/js/30.d080d13b.js"><link rel="prefetch" href="/assets/js/300.c6ffa0af.js"><link rel="prefetch" href="/assets/js/301.547a5da0.js"><link rel="prefetch" href="/assets/js/302.991b9208.js"><link rel="prefetch" href="/assets/js/303.8f832666.js"><link rel="prefetch" href="/assets/js/304.8f70c766.js"><link rel="prefetch" href="/assets/js/305.375ca5d4.js"><link rel="prefetch" href="/assets/js/306.77f2b6e5.js"><link rel="prefetch" href="/assets/js/307.9b51ec62.js"><link rel="prefetch" href="/assets/js/308.6d0bcde0.js"><link rel="prefetch" href="/assets/js/309.c2560822.js"><link rel="prefetch" href="/assets/js/31.cac1c135.js"><link rel="prefetch" href="/assets/js/310.5f461822.js"><link rel="prefetch" href="/assets/js/311.b677460a.js"><link rel="prefetch" href="/assets/js/312.f0627fb2.js"><link rel="prefetch" href="/assets/js/313.04a6df0b.js"><link rel="prefetch" href="/assets/js/314.ed1493e5.js"><link rel="prefetch" href="/assets/js/315.76cd4a9b.js"><link rel="prefetch" href="/assets/js/316.b1e405c6.js"><link rel="prefetch" href="/assets/js/317.ae13d1dd.js"><link rel="prefetch" href="/assets/js/318.38402487.js"><link rel="prefetch" href="/assets/js/319.b599b20c.js"><link rel="prefetch" href="/assets/js/32.d1a10817.js"><link rel="prefetch" href="/assets/js/320.8cda6965.js"><link rel="prefetch" href="/assets/js/321.6d23d913.js"><link rel="prefetch" href="/assets/js/322.5c6afd7c.js"><link rel="prefetch" href="/assets/js/323.3a00fc35.js"><link rel="prefetch" href="/assets/js/324.bddb3317.js"><link rel="prefetch" href="/assets/js/325.a67c445b.js"><link rel="prefetch" href="/assets/js/326.35351bf6.js"><link rel="prefetch" href="/assets/js/327.2ec4de5e.js"><link rel="prefetch" href="/assets/js/328.0269fc2d.js"><link rel="prefetch" href="/assets/js/329.8a070436.js"><link rel="prefetch" href="/assets/js/33.d717808e.js"><link rel="prefetch" href="/assets/js/330.fb6eb821.js"><link rel="prefetch" href="/assets/js/331.23f95cd0.js"><link rel="prefetch" href="/assets/js/332.0abbc779.js"><link rel="prefetch" href="/assets/js/333.3e30f739.js"><link rel="prefetch" href="/assets/js/334.ceee0f2d.js"><link rel="prefetch" href="/assets/js/335.17972dcc.js"><link rel="prefetch" href="/assets/js/336.95493282.js"><link rel="prefetch" href="/assets/js/337.28ba35bb.js"><link rel="prefetch" href="/assets/js/338.393546ae.js"><link rel="prefetch" href="/assets/js/339.6f686732.js"><link rel="prefetch" href="/assets/js/34.eac2aef5.js"><link rel="prefetch" href="/assets/js/340.781006c9.js"><link rel="prefetch" href="/assets/js/341.75fc230d.js"><link rel="prefetch" href="/assets/js/342.7af7d92b.js"><link rel="prefetch" href="/assets/js/343.92af3748.js"><link rel="prefetch" href="/assets/js/344.547f36f8.js"><link rel="prefetch" href="/assets/js/345.fa8e4779.js"><link rel="prefetch" href="/assets/js/346.f9252d71.js"><link rel="prefetch" href="/assets/js/347.5efddb1a.js"><link rel="prefetch" href="/assets/js/348.1d050da9.js"><link rel="prefetch" href="/assets/js/349.3a6a191d.js"><link rel="prefetch" href="/assets/js/35.af699a6d.js"><link rel="prefetch" href="/assets/js/350.1e5f86af.js"><link rel="prefetch" href="/assets/js/351.7e677cdc.js"><link rel="prefetch" href="/assets/js/352.8db30093.js"><link rel="prefetch" href="/assets/js/353.4d9fdedc.js"><link rel="prefetch" href="/assets/js/354.e3865d5e.js"><link rel="prefetch" href="/assets/js/355.43f14008.js"><link rel="prefetch" href="/assets/js/356.6d864900.js"><link rel="prefetch" href="/assets/js/357.a018e358.js"><link rel="prefetch" href="/assets/js/358.2e7926d4.js"><link rel="prefetch" href="/assets/js/359.65aaa7fb.js"><link rel="prefetch" href="/assets/js/36.710b9e51.js"><link rel="prefetch" href="/assets/js/360.2782be02.js"><link rel="prefetch" href="/assets/js/361.6418e6f0.js"><link rel="prefetch" href="/assets/js/362.548bb78f.js"><link rel="prefetch" href="/assets/js/363.4576ea77.js"><link rel="prefetch" href="/assets/js/364.94f183a6.js"><link rel="prefetch" href="/assets/js/365.eb486708.js"><link rel="prefetch" href="/assets/js/366.76566d5f.js"><link rel="prefetch" href="/assets/js/367.216ea156.js"><link rel="prefetch" href="/assets/js/368.421561c8.js"><link rel="prefetch" href="/assets/js/369.c48fc2dd.js"><link rel="prefetch" href="/assets/js/37.98a25780.js"><link rel="prefetch" href="/assets/js/370.75f07d86.js"><link rel="prefetch" href="/assets/js/371.e58ac69a.js"><link rel="prefetch" href="/assets/js/372.ff472718.js"><link rel="prefetch" href="/assets/js/373.f91c21ba.js"><link rel="prefetch" href="/assets/js/374.0b54cc42.js"><link rel="prefetch" href="/assets/js/375.93dffa67.js"><link rel="prefetch" href="/assets/js/376.5a29a118.js"><link rel="prefetch" href="/assets/js/377.f08430c0.js"><link rel="prefetch" href="/assets/js/378.ffc10305.js"><link rel="prefetch" href="/assets/js/379.8e61e9de.js"><link rel="prefetch" href="/assets/js/38.d69ba5f9.js"><link rel="prefetch" href="/assets/js/380.09cd0812.js"><link rel="prefetch" href="/assets/js/381.eefb8f60.js"><link rel="prefetch" href="/assets/js/382.5a48b778.js"><link rel="prefetch" href="/assets/js/383.5fc90858.js"><link rel="prefetch" href="/assets/js/384.2ff7bbad.js"><link rel="prefetch" href="/assets/js/385.62783266.js"><link rel="prefetch" href="/assets/js/386.3ebeff5b.js"><link rel="prefetch" href="/assets/js/387.4ca2c379.js"><link rel="prefetch" href="/assets/js/388.f2de24f4.js"><link rel="prefetch" href="/assets/js/389.eea4f391.js"><link rel="prefetch" href="/assets/js/39.f72ab6b0.js"><link rel="prefetch" href="/assets/js/390.bb66bb81.js"><link rel="prefetch" href="/assets/js/391.f60ac996.js"><link rel="prefetch" href="/assets/js/392.e68fc6bf.js"><link rel="prefetch" href="/assets/js/393.20772627.js"><link rel="prefetch" href="/assets/js/394.c7dadbd0.js"><link rel="prefetch" href="/assets/js/395.0138c145.js"><link rel="prefetch" href="/assets/js/396.084c963c.js"><link rel="prefetch" href="/assets/js/397.f5ab4817.js"><link rel="prefetch" href="/assets/js/398.051211b3.js"><link rel="prefetch" href="/assets/js/399.bc892b4d.js"><link rel="prefetch" href="/assets/js/40.7f149bef.js"><link rel="prefetch" href="/assets/js/400.a53c2513.js"><link rel="prefetch" href="/assets/js/401.3db14319.js"><link rel="prefetch" href="/assets/js/402.83ac693b.js"><link rel="prefetch" href="/assets/js/403.13784c1f.js"><link rel="prefetch" href="/assets/js/41.9369d28d.js"><link rel="prefetch" href="/assets/js/42.b2a889f6.js"><link rel="prefetch" href="/assets/js/43.3c0d6b4e.js"><link rel="prefetch" href="/assets/js/44.674c3905.js"><link rel="prefetch" href="/assets/js/45.0546b2d6.js"><link rel="prefetch" href="/assets/js/46.0a460c34.js"><link rel="prefetch" href="/assets/js/47.365989ba.js"><link rel="prefetch" href="/assets/js/48.7835be2c.js"><link rel="prefetch" href="/assets/js/49.22ee7a80.js"><link rel="prefetch" href="/assets/js/5.e8a60949.js"><link rel="prefetch" href="/assets/js/50.2db190b1.js"><link rel="prefetch" href="/assets/js/51.17f9deee.js"><link rel="prefetch" href="/assets/js/52.11a7ff10.js"><link rel="prefetch" href="/assets/js/53.de277eda.js"><link rel="prefetch" href="/assets/js/54.81ee491e.js"><link rel="prefetch" href="/assets/js/55.7f27f8a1.js"><link rel="prefetch" href="/assets/js/56.a3c2077f.js"><link rel="prefetch" href="/assets/js/57.53f1a3f2.js"><link rel="prefetch" href="/assets/js/58.0fb67481.js"><link rel="prefetch" href="/assets/js/59.a36c79f7.js"><link rel="prefetch" href="/assets/js/6.ff783162.js"><link rel="prefetch" href="/assets/js/60.b592da2e.js"><link rel="prefetch" href="/assets/js/61.c05c2bba.js"><link rel="prefetch" href="/assets/js/62.69a447fc.js"><link rel="prefetch" href="/assets/js/63.ed0eeaeb.js"><link rel="prefetch" href="/assets/js/64.e87722fb.js"><link rel="prefetch" href="/assets/js/65.944f93ec.js"><link rel="prefetch" href="/assets/js/66.2daebee7.js"><link rel="prefetch" href="/assets/js/67.4455d860.js"><link rel="prefetch" href="/assets/js/68.54ec05f9.js"><link rel="prefetch" href="/assets/js/69.fa08b217.js"><link rel="prefetch" href="/assets/js/70.9921bfa5.js"><link rel="prefetch" href="/assets/js/71.6a84c899.js"><link rel="prefetch" href="/assets/js/72.f7633bf8.js"><link rel="prefetch" href="/assets/js/73.6d7e1828.js"><link rel="prefetch" href="/assets/js/74.913a0394.js"><link rel="prefetch" href="/assets/js/75.d58eea21.js"><link rel="prefetch" href="/assets/js/76.94181a9d.js"><link rel="prefetch" href="/assets/js/77.f7d5a873.js"><link rel="prefetch" href="/assets/js/78.2ba0d535.js"><link rel="prefetch" href="/assets/js/79.1fe57f6d.js"><link rel="prefetch" href="/assets/js/8.abecde44.js"><link rel="prefetch" href="/assets/js/80.cabbcabe.js"><link rel="prefetch" href="/assets/js/81.25f44d08.js"><link rel="prefetch" href="/assets/js/82.89be1b47.js"><link rel="prefetch" href="/assets/js/83.53f01a71.js"><link rel="prefetch" href="/assets/js/85.f45bc74b.js"><link rel="prefetch" href="/assets/js/86.52df52ce.js"><link rel="prefetch" href="/assets/js/87.d92b2eea.js"><link rel="prefetch" href="/assets/js/88.3d0c2cec.js"><link rel="prefetch" href="/assets/js/89.59420407.js"><link rel="prefetch" href="/assets/js/9.0809b3b9.js"><link rel="prefetch" href="/assets/js/90.7c8a7179.js"><link rel="prefetch" href="/assets/js/91.b6f05f98.js"><link rel="prefetch" href="/assets/js/92.aedc32e1.js"><link rel="prefetch" href="/assets/js/93.626546b0.js"><link rel="prefetch" href="/assets/js/94.dd2d36dc.js"><link rel="prefetch" href="/assets/js/95.054e5002.js"><link rel="prefetch" href="/assets/js/96.941a3452.js"><link rel="prefetch" href="/assets/js/97.13025a37.js"><link rel="prefetch" href="/assets/js/98.7a1167b4.js"><link rel="prefetch" href="/assets/js/99.561291a3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.75a488ab.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/index/logo.png" alt="阿星 精神时の屋" class="logo"> <span class="site-name can-hide">阿星 精神时の屋</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title router-link-active">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link router-link-active">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/typescript/" class="nav-link">TypeScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/website/introduce/" class="nav-link">关于</a></li></ul></li></ul></div></div> <a href="https://github.com/mijingduI/mijingdui.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/mijingduI/image-hosting@master/20230308/blog20230308235831.zff5bilpq4g.webp"> <div class="blogger-info"><h3>日暮途远</h3> <span>朝圣的使徒，正在走向编程的至高殿堂！</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title router-link-active">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link router-link-active">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/typescript/" class="nav-link">TypeScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/website/introduce/" class="nav-link">关于</a></li></ul></li></ul></div></div> <a href="https://github.com/mijingduI/mijingdui.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础 - SE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java进阶 - SE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java集合 - Collection</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java并发 - JUC</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/juc/concept/" class="sidebar-link">JUC - 概念</a></li><li><a href="/java/juc/java/" class="sidebar-link">JUC - Java线程</a></li><li><a href="/java/juc/tube-side-security/" class="sidebar-link">JUC - 共享模型之管程安全</a></li><li><a href="/java/juc/lock-basics/" class="sidebar-link">JUC - 共享模式之锁基础</a></li><li><a href="/java/juc/lock-advanced/" aria-current="page" class="active sidebar-link">JUC - 共享模式之锁进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/java/juc/lock-advanced/#park-unpark" class="sidebar-link">Park &amp; Unpark</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#基本使用" class="sidebar-link">基本使用</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#特点" class="sidebar-link">特点</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#park-和-unpark-原理" class="sidebar-link">park 和 unpark 原理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/juc/lock-advanced/#重新理解线程状态转换" class="sidebar-link">重新理解线程状态转换</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#多种情况" class="sidebar-link">多种情况</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/juc/lock-advanced/#多把锁" class="sidebar-link">多把锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#多把不相干的锁" class="sidebar-link">多把不相干的锁</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#锁粒度细分优缺点" class="sidebar-link">锁粒度细分优缺点</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/juc/lock-advanced/#活跃性" class="sidebar-link">活跃性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#死锁" class="sidebar-link">死锁</a></li><li class="sidebar-sub-header level4"><a href="/java/juc/lock-advanced/#定位死锁" class="sidebar-link">定位死锁</a></li><li class="sidebar-sub-header level4"><a href="/java/juc/lock-advanced/#哲学家就餐问题" class="sidebar-link">哲学家就餐问题</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#活锁" class="sidebar-link">活锁</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#饥饿" class="sidebar-link">饥饿</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#公平锁非公平锁" class="sidebar-link">公平锁非公平锁</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#可重入锁" class="sidebar-link">可重入锁</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#自旋锁" class="sidebar-link">自旋锁</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/juc/lock-advanced/#reentrantlock" class="sidebar-link">ReentrantLock</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#可重入" class="sidebar-link">可重入</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#可打断" class="sidebar-link">可打断</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#锁超时" class="sidebar-link">锁超时</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#使用-trylock-解决哲学家就餐问题" class="sidebar-link">使用 tryLock 解决哲学家就餐问题</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#公平锁" class="sidebar-link">公平锁</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#条件变量" class="sidebar-link">条件变量</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#区别" class="sidebar-link">区别</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/juc/lock-advanced/#同步模式之顺序控制" class="sidebar-link">同步模式之顺序控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#固定运行顺序" class="sidebar-link">固定运行顺序</a></li><li class="sidebar-sub-header level4"><a href="/java/juc/lock-advanced/#wait-notify-版" class="sidebar-link">wait notify 版</a></li><li class="sidebar-sub-header level4"><a href="/java/juc/lock-advanced/#park-unpark-版" class="sidebar-link">Park Unpark 版</a></li><li class="sidebar-sub-header level3"><a href="/java/juc/lock-advanced/#交替输出" class="sidebar-link">交替输出</a></li><li class="sidebar-sub-header level4"><a href="/java/juc/lock-advanced/#wait-notify-版-2" class="sidebar-link">wait notify 版</a></li><li class="sidebar-sub-header level4"><a href="/java/juc/lock-advanced/#lock-条件变量版" class="sidebar-link">Lock 条件变量版</a></li><li class="sidebar-sub-header level4"><a href="/java/juc/lock-advanced/#park-unpark-版-2" class="sidebar-link">Park Unpark 版</a></li></ul></li></ul></li><li><a href="/java/juc/memory/" class="sidebar-link">JUC - 共享模式之内存</a></li><li><a href="/java/juc/no-lock/" class="sidebar-link">JUC - 共享模型之无锁</a></li><li><a href="/java/juc/immutable/" class="sidebar-link">JUC - 共享模型之不可变</a></li><li><a href="/java/juc/thread-pool/" class="sidebar-link">JUC - 共享模型之线程池</a></li><li><a href="/java/juc/reentrantReadWriteLock/" class="sidebar-link">JUC - 共享模型之读写锁</a></li><li><a href="/java/juc/concurrent-class/" class="sidebar-link">JUC - 共享模式之并发类</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java容器 - Web</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java底层 - JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java版本 - 新特性</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=Java" title="分类" data-v-06225672>Java</a></li><li data-v-06225672><a href="/categories/?category=Java%E5%B9%B6%E5%8F%91%20-%20JUC" title="分类" data-v-06225672>Java并发 - JUC</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://mijingdui.github.io" target="_blank" title="作者" class="beLink" data-v-06225672>阿星 </a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-05-12</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">JUC - 共享模式之锁进阶<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#park-unpark">Park &amp; Unpark</a><ul><li><a href="#基本使用">基本使用</a></li><li><a href="#特点">特点</a></li><li><a href="#park-和-unpark-原理">park 和 unpark 原理</a></li></ul></li><li><a href="#重新理解线程状态转换">重新理解线程状态转换</a><ul><li><a href="#多种情况">多种情况</a></li><li><a href="#总结">总结</a></li></ul></li><li><a href="#多把锁">多把锁</a><ul><li><a href="#多把不相干的锁">多把不相干的锁</a></li><li><a href="#锁粒度细分优缺点">锁粒度细分优缺点</a></li></ul></li><li><a href="#活跃性">活跃性</a><ul><li><a href="#死锁">死锁</a></li><li><a href="#活锁">活锁</a></li><li><a href="#饥饿">饥饿</a></li><li><a href="#公平锁非公平锁">公平锁非公平锁</a></li><li><a href="#可重入锁">可重入锁</a></li><li><a href="#自旋锁">自旋锁</a></li></ul></li><li><a href="#reentrantlock">ReentrantLock</a><ul><li><a href="#可重入">可重入</a></li><li><a href="#可打断">可打断</a></li><li><a href="#锁超时">锁超时</a></li><li><a href="#使用-trylock-解决哲学家就餐问题">使用 tryLock 解决哲学家就餐问题</a></li><li><a href="#公平锁">公平锁</a></li><li><a href="#条件变量">条件变量</a></li><li><a href="#区别">区别</a></li></ul></li><li><a href="#同步模式之顺序控制">同步模式之顺序控制</a><ul><li><a href="#固定运行顺序">固定运行顺序</a></li><li><a href="#交替输出">交替输出</a></li></ul></li></ul></div><p></p> <h2 id="park-unpark"><a href="#park-unpark" class="header-anchor">#</a> Park &amp; Unpark</h2> <h3 id="基本使用"><a href="#基本使用" class="header-anchor">#</a> 基本使用</h3> <p>它们是 LockSupport 类中的方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 暂停当前线程</span>
<span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 恢复某个线程的运行</span>
<span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>暂停线程对象<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>先 park 再 unpark</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;start...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;park...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;resume...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;unpark...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">18</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">52.585</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestParkUnpark</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token operator">-</span> start<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">53.589</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestParkUnpark</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token operator">-</span> park<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">54.583</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestParkUnpark</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token operator">-</span> unpark<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">54.583</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestParkUnpark</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token operator">-</span> resume<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>park 会让线程暂停，unpark 取消 park 的效果，让线程继续运行。</p> <blockquote><p>先 unpark 再 park</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;start...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;park...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;resume...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;unpark...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">18</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">50.765</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestParkUnpark</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token operator">-</span> start<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">51.764</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestParkUnpark</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token operator">-</span> unpark<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">52.769</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestParkUnpark</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token operator">-</span> park<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">52.769</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestParkUnpark</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token operator">-</span> resume<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>所以先 unpark，再 park，那么不会暂停线程。因为 unpark 内部事先已经准备了一个「东西」让后面的 park 失效（只是后面的第一个 park，如果再调用一次 park，则线程会暂停）。</p> <h3 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h3> <p>与 Object 的 wait &amp; notify 相比：</p> <ul><li>wait &amp; notify 和 notifyAll 必须配合 <code>Object Monitor</code> 一起使用，而 park，unpark 不必</li> <li>park &amp; unpark 是以线程为单位来「阻塞」和「唤醒」线程，而 notify 只能随机唤醒一个等待线程，notifyAll 是唤醒所有等待线程，就不那么「精确」</li> <li>park &amp; unpark 可以先 unpark，而 wait &amp; notify 不能先 notify</li></ul> <h3 id="park-和-unpark-原理"><a href="#park-和-unpark-原理" class="header-anchor">#</a> park 和 unpark 原理</h3> <p>每个线程都有自己的一个 Parker 对象，由三部分组成 _counter， _cond 和 _mutex，</p> <p>_counter 用来判断是否暂停线程（0 暂停，1 不暂停）， _cond 是存放暂停线程的空间， _mutex 是互斥锁，打个比喻：</p> <ul><li>线程就像一个旅人，Parker 就像他随身携带的背包，条件变量就好比背包中的帐篷。_counter 就好比背包中的备用干粮（0 为耗尽，1 为充足）</li> <li>调用 park 就是要看需不需要停下来歇息
<ul><li>如果备用干粮耗尽，那么钻进帐篷歇息</li> <li>如果备用干粮充足，那么不需停留，继续前进</li></ul></li> <li>调用 unpark，就好比令干粮充足
<ul><li>如果这时线程还在帐篷，就唤醒让他继续前进</li> <li>如果这时线程还在运行，那么下次他调用 park 时，仅是消耗掉备用干粮，不需停留继续前进
<ul><li>因为背包空间有限，多次调用 unpark 仅会补充一份备用干粮</li></ul></li></ul></li></ul> <blockquote><p>调用 park</p></blockquote> <p><img src="https://cdn.staticaly.com/gh/Kele-Bingtang/static@master/img/juc/20220511230653.png" alt="image-20220511230627670"></p> <ul><li>当前线程调用 <code>Unsafe.park()</code> 方法</li> <li>检查 _counter，本情况为 0，这时获得 _mutex 互斥锁</li> <li>线程进入 _cond 条件变量，变成阻塞状态</li> <li>设置 _counter = 0，代表暂停线程</li></ul> <blockquote><p>调用 unpark</p></blockquote> <p><img src="https://cdn.staticaly.com/gh/Kele-Bingtang/static@master/img/juc/20220511230849.png" alt="image-20220511230848615"></p> <ul><li>调用 <code>Unsafe.unpark(Thread_0)</code> 方法，设置 _counter 为 1，代表恢复线程</li> <li>唤醒 _cond 条件变量中的 Thread_0</li> <li>Thread_0 恢复运行</li> <li>设置 _counter 为 0，代表下一次调用 park 的线程暂停</li></ul> <blockquote><p>先调用 unpark，再调用 park</p></blockquote> <p><img src="https://cdn.staticaly.com/gh/Kele-Bingtang/static@master/img/juc/20220511230935.png" alt="image-20220511230931925"></p> <ul><li>调用 <code>Unsafe.unpark(Thread_0)</code> 方法，设置 _counter 为 1，代表恢复线程，这里指的是下一个调用 park 的线程直接恢复运行</li> <li>当前线程调用 <code>Unsafe.park()</code> 方法</li> <li>检查 _counter，此时为 1，这时线程无需阻塞，继续运行</li> <li>设置 _counter 为 0，代表下一次调用 park 的线程暂停</li></ul> <h2 id="重新理解线程状态转换"><a href="#重新理解线程状态转换" class="header-anchor">#</a> 重新理解线程状态转换</h2> <p><img src="https://cdn.staticaly.com/gh/Kele-Bingtang/static@master/img/juc/20220508012803.png" alt="image-20220508012802238"></p> <h3 id="多种情况"><a href="#多种情况" class="header-anchor">#</a> 多种情况</h3> <p>假设有线程 Thread t。</p> <blockquote><p>情况 1 NEW --&gt; RUNNABLE</p></blockquote> <p>当调用 <code>t.start()</code> 方法时，由 NEW --&gt; RUNNABLE</p> <blockquote><p>情况 2 RUNNABLE &lt;--&gt; WAITING</p></blockquote> <p>t 线程用 <code>synchronized(obj)</code> 获取了对象锁后</p> <ul><li>调用 <code>obj.wait()</code> 方法时，t 线程从 RUNNABLE --&gt; WAITING</li> <li>调用 <code>obj.notify()</code>，<code>obj.notifyAll()</code>，<code>t.interrupt()</code> 时
<ul><li>竞争锁成功，t 线程从 WAITING --&gt; RUNNABLE</li> <li>竞争锁失败，t 线程从 WAITING --&gt; BLOCKED</li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestWaitNotify</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;执行....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    obj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;其它代码....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 断点</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;执行....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    obj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;其它代码....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 断点</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;唤醒 obj 上其它线程&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            obj<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 唤醒obj上所有等待线程 断点</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><blockquote><p>情况 3 RUNNABLE &lt;--&gt; WAITING</p></blockquote> <ul><li>当前线程调用 <code>t.join()</code> 方法时，当前线程从 RUNNABLE --&gt; WAITING
<ul><li>注意是当前线程在 t 线程对象的监视器上等待</li></ul></li> <li>t 线程运行结束，或调用了当前线程的 <code>interrupt()</code> 时，当前线程从 WAITING --&gt; RUNNABLE</li></ul> <blockquote><p>情况 4 RUNNABLE &lt;--&gt; WAITING</p></blockquote> <ul><li>当前线程调用 <code>LockSupport.park()</code> 方法会让当前线程从 RUNNABLE --&gt; WAITING</li> <li>调用 <code>LockSupport.unpark(目标线程)</code> 或调用了线程的 <code>interrupt()</code>，会让目标线程从 WAITING --&gt;  RUNNABLE</li></ul> <blockquote><p>情况 5 RUNNABLE &lt;--&gt; TIMED_WAITING</p></blockquote> <p>t 线程用 <code>synchronized(obj)</code> 获取了对象锁后</p> <ul><li>调用 <code>obj.wait(long n)</code> 方法时，t 线程从 RUNNABLE --&gt; TIMED_WAITING</li> <li>t 线程等待时间超过了 n 毫秒，或调用 <code>obj.notify()</code>，<code>obj.notifyAll()</code>，<code>t.interrupt()</code> 时
<ul><li>竞争锁成功，t 线程从 TIMED_WAITING --&gt; RUNNABLE</li> <li>竞争锁失败，t 线程从 TIMED_WAITING --&gt; BLOCKED</li></ul></li></ul> <blockquote><p>情况 6 RUNNABLE &lt;--&gt; TIMED_WAITING</p></blockquote> <ul><li>当前线程调用 <code>t.join(long n)</code> 方法时，当前线程从 RUNNABLE --&gt; TIMED_WAITING
<ul><li>注意是当前线程在 t 线程对象的监视器上等待</li></ul></li> <li>当前线程等待时间超过了 n 毫秒，或 t 线程运行结束，或调用了当前线程的 <code>interrupt()</code> 时，当前线程从 TIMED_WAITING --&gt; RUNNABLE</li></ul> <blockquote><p>情况 7 RUNNABLE &lt;--&gt; TIMED_WAITING</p></blockquote> <ul><li>当前线程调用 <code>Thread.sleep(long n)</code>，当前线程从 RUNNABLE --&gt; TIMED_WAITING</li> <li>当前线程等待时间超过了 n 毫秒，当前线程从 TIMED_WAITING --&gt; RUNNABLE</li></ul> <blockquote><p>情况 8 RUNNABLE &lt;--&gt; TIMED_WAITING</p></blockquote> <ul><li>当前线程调用 <code>LockSupport.parkNanos(long nanos)</code> 或 <code>LockSupport.parkUntil(long millis)</code> 时，当前线程从 RUNNABLE --&gt; TIMED_WAITING</li> <li>调用 <code>LockSupport.unpark(目标线程)</code> 或调用了线程的 <code>interrupt()</code>，或是等待超时，会让目标线程从 TIMED_WAITING--&gt; RUNNABLE</li></ul> <blockquote><p>情况 9 RUNNABLE &lt;--&gt; BLOCKED</p></blockquote> <ul><li>t 线程用 <code>synchronized(obj)</code> 获取了对象锁时如果竞争失败，从 RUNNABLE --&gt; BLOCKED</li> <li>持 obj 锁线程的同步代码块执行完毕，会唤醒该对象上所有 BLOCKED 的线程重新竞争，如果其中 t 线程竞争成功，从 BLOCKED --&gt; RUNNABLE ，其它失败的线程仍然 BLOCKED</li></ul> <blockquote><p>情况 10 RUNNABLE &lt;--&gt; TERMINATED</p></blockquote> <p>当前线程所有代码运行完毕，进入 TERMINATED。</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <ul><li>任意线程调用 wait、join、park 等多线程方法都会进入 WAITING 状态</li> <li>任意线程竞争抢锁失败，进入 BLOCKED 状态，竞争抢锁成功，则进入 RUNNABLE 状态</li> <li>任意线程调用带有时间参数的多线程方法，如 <code>wait(long n)</code>、<code>join(long n)</code>、<code>sleep(long n)</code>、<code>parkUntil(long millis)</code> 等，都进入 TIMED_WAITING 状态</li> <li>任意线程抢到锁后，都直接进入 RUNNABLE 状态</li></ul> <h2 id="多把锁"><a href="#多把锁" class="header-anchor">#</a> 多把锁</h2> <h3 id="多把不相干的锁"><a href="#多把不相干的锁" class="header-anchor">#</a> 多把不相干的锁</h3> <p>一间大屋子有两个功能：睡觉、学习，互不相干。</p> <p>现在小南要学习，小女要睡觉，但如果只用一间屋子（一个对象锁）的话，那么并发度很低。</p> <p>例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">BigRoom</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;sleeping 2 小时&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 睡 2s</span>
            <span class="token class-name">Sleeper</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;study 1 小时&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 睡 1s</span>
            <span class="token class-name">Sleeper</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BigRoom</span> bigRoom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigRoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            bigRoom<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;小南&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            bigRoom<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;小女&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>某次执行结果：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">12</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">54.471</span> <span class="token punctuation">[</span>小南<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>BigRoom</span> <span class="token operator">-</span> study <span class="token number">1</span> 小时
<span class="token number">12</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">55.476</span> <span class="token punctuation">[</span>小女<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>BigRoom</span> <span class="token operator">-</span> sleeping <span class="token number">2</span> 小时
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>解决方法：准备多个房间（多个对象锁）。</p> <p>改进代码：</p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">BigRoom</span> <span class="token punctuation">{</span>
    <span class="token comment">// 多了两把锁</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> studyRoom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> bedRoom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>bedRoom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;sleeping 2 小时&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Sleeper</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>studyRoom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;study 1 小时&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Sleeper</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BigRoom</span> bigRoom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigRoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            bigRoom<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;小南&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            bigRoom<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;小女&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>某次执行结果：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">12</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">35.069</span> <span class="token punctuation">[</span>小南<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>BigRoom</span> <span class="token operator">-</span> study <span class="token number">1</span> 小时
<span class="token number">12</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">35.069</span> <span class="token punctuation">[</span>小女<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>BigRoom</span> <span class="token operator">-</span> sleeping <span class="token number">2</span> 小时
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="锁粒度细分优缺点"><a href="#锁粒度细分优缺点" class="header-anchor">#</a> 锁粒度细分优缺点</h3> <ul><li>优点：是可以增强并发度</li> <li>缺点：如果一个线程需要同时获得多把锁，就容易发生死锁</li></ul> <h2 id="活跃性"><a href="#活跃性" class="header-anchor">#</a> 活跃性</h2> <h3 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h3> <p>有这样的情况：一个线程需要同时获取多把锁，这时就容易发生死锁。</p> <ul><li>t1 线程获得 A 对象锁，接下来想获取 B 对象的锁</li> <li>t2 线程获得 B 对象锁，接下来想获取 A 对象的锁</li></ul> <p>例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> <span class="token class-name">A</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> <span class="token class-name">B</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;lock A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 试图获取 B 的锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;lock B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;操作...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;lock B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 试图获取 A 的锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;lock A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;操作...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">12</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">06.962</span> <span class="token punctuation">[</span>t2<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestDeadLock</span> <span class="token operator">-</span> lock <span class="token class-name">B</span> 
<span class="token number">12</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">06.962</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestDeadLock</span> <span class="token operator">-</span> lock <span class="token class-name">A</span>
<span class="token comment">// 卡在这里, 不向下运行</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="定位死锁"><a href="#定位死锁" class="header-anchor">#</a> 定位死锁</h4> <p>检测死锁可以使用 jconsole 工具，或者使用 jps 定位进程 id，再用 jstack 定位死锁：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>cmd <span class="token operator">&gt;</span> jps
Picked up JAVA_TOOL_OPTIONS: <span class="token parameter variable">-Dfile.encoding</span><span class="token operator">=</span>UTF-8
<span class="token number">12320</span> Jps
<span class="token number">22816</span> KotlinCompileDaemon
<span class="token number">33200</span> TestDeadLock // JVM 进程
<span class="token number">11508</span> Main
<span class="token number">28468</span> Launcher
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>输出（截取部分）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Found</span> one <span class="token class-name">Java</span><span class="token operator">-</span>level deadlock<span class="token operator">:</span>  <span class="token comment">// 发现一个 Java 级别的死锁</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token string">&quot;Thread-1&quot;</span><span class="token operator">:</span>
 waiting <span class="token keyword">to</span> <span class="token namespace">lock</span> monitor <span class="token number">0x000000000361d378</span> <span class="token punctuation">(</span>object <span class="token number">0x000000076b5bf1c0</span><span class="token punctuation">,</span> a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 which is held by <span class="token string">&quot;Thread-0&quot;</span>
<span class="token string">&quot;Thread-0&quot;</span><span class="token operator">:</span>
 waiting <span class="token keyword">to</span> <span class="token namespace">lock</span> monitor <span class="token number">0x000000000361e768</span> <span class="token punctuation">(</span>object <span class="token number">0x000000076b5bf1d0</span><span class="token punctuation">,</span> a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 which is held by <span class="token string">&quot;Thread-1&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li><strong>避免死锁要注意加锁顺序</strong></li> <li>另外如果由于某个线程进入了死循环，导致其它线程一直等待，对于这种情况 linux 下可以通过 top 先定位到 CPU 占用高的 Java 进程，再利用 <code>top -Hp</code> 进程 id 来定位是哪个线程，最后再用 jstack 排查</li></ul> <h4 id="哲学家就餐问题"><a href="#哲学家就餐问题" class="header-anchor">#</a> 哲学家就餐问题</h4> <p><img src="https://cdn.staticaly.com/gh/Kele-Bingtang/static@master/img/juc/20220512005452.png" alt="image-20220512005451474"></p> <p>有五位哲学家，围坐在圆桌旁。</p> <ul><li>他们只做两件事，思考和吃饭，思考一会吃口饭，吃完饭后接着思考</li> <li>吃饭时要用两根筷子吃，桌上共有 5 根筷子，每位哲学家左右手边各有一根筷子</li> <li>如果筷子被身边的人拿着，自己就得等待</li></ul> <p>假设五位哲学家分别拿起一个筷子，且不放下，则五位哲学家就一直等待其他人放下筷子，但是<strong>其他人不放下，则僵持产生死锁</strong>。</p> <p>筷子类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Chopstick</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;筷子{&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token char">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>哲学家类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Philosopher</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token class-name">Chopstick</span> left<span class="token punctuation">;</span>
    <span class="token class-name">Chopstick</span> right<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Chopstick</span> left<span class="token punctuation">,</span> <span class="token class-name">Chopstick</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> left<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> right<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;eating...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Sleeper</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获得左手筷子</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 获得右手筷子</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 吃饭</span>
                    <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 放下右手筷子</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 放下左手筷子</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>就餐测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Chopstick</span> c1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;苏格拉底&quot;</span><span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;柏拉图&quot;</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;亚里士多德&quot;</span><span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;赫拉克利特&quot;</span><span class="token punctuation">,</span> c4<span class="token punctuation">,</span> c5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;阿基米德&quot;</span><span class="token punctuation">,</span> c5<span class="token punctuation">,</span> c1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>输出结果（截取死锁部分）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">12</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">15.575</span> <span class="token punctuation">[</span>苏格拉底<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>Philosopher</span> <span class="token operator">-</span> eating<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">12</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">15.575</span> <span class="token punctuation">[</span>亚里士多德<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>Philosopher</span> <span class="token operator">-</span> eating<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">12</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">16.580</span> <span class="token punctuation">[</span>阿基米德<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>Philosopher</span> <span class="token operator">-</span> eating<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">12</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">17.580</span> <span class="token punctuation">[</span>阿基米德<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>Philosopher</span> <span class="token operator">-</span> eating<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token comment">// 卡在这里, 不向下运行</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>使用 jconsole 检测死锁，发现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
名称<span class="token operator">:</span> 阿基米德
状态<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@1540e19d</span> <span class="token punctuation">(</span>筷子<span class="token number">1</span><span class="token punctuation">)</span> 上的<span class="token constant">BLOCKED</span><span class="token punctuation">,</span> 拥有者<span class="token operator">:</span> 苏格拉底
总阻止数<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> 总等待数<span class="token operator">:</span> <span class="token number">1</span>
堆栈跟踪<span class="token operator">:</span>
<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Philosopher</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestDinner</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">)</span>
 <span class="token operator">-</span> 已锁定 <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@6d6f6e28</span> <span class="token punctuation">(</span>筷子<span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
名称<span class="token operator">:</span> 苏格拉底
状态<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@677327b6</span> <span class="token punctuation">(</span>筷子<span class="token number">2</span><span class="token punctuation">)</span> 上的<span class="token constant">BLOCKED</span><span class="token punctuation">,</span> 拥有者<span class="token operator">:</span> 柏拉图
总阻止数<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> 总等待数<span class="token operator">:</span> <span class="token number">1</span>
堆栈跟踪<span class="token operator">:</span>
<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Philosopher</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestDinner</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">)</span>
 <span class="token operator">-</span> 已锁定 <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@1540e19d</span> <span class="token punctuation">(</span>筷子<span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
名称<span class="token operator">:</span> 柏拉图
状态<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@14ae5a5</span> <span class="token punctuation">(</span>筷子<span class="token number">3</span><span class="token punctuation">)</span> 上的<span class="token constant">BLOCKED</span><span class="token punctuation">,</span> 拥有者<span class="token operator">:</span> 亚里士多德
总阻止数<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> 总等待数<span class="token operator">:</span> <span class="token number">0</span>
堆栈跟踪<span class="token operator">:</span>
<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Philosopher</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestDinner</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">)</span>
 <span class="token operator">-</span> 已锁定 <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@677327b6</span> <span class="token punctuation">(</span>筷子<span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
名称<span class="token operator">:</span> 亚里士多德
状态<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@7f31245a</span> <span class="token punctuation">(</span>筷子<span class="token number">4</span><span class="token punctuation">)</span> 上的<span class="token constant">BLOCKED</span><span class="token punctuation">,</span> 拥有者<span class="token operator">:</span> 赫拉克利特
总阻止数<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> 总等待数<span class="token operator">:</span> <span class="token number">1</span>
堆栈跟踪<span class="token operator">:</span>
<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Philosopher</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestDinner</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">)</span>
 <span class="token operator">-</span> 已锁定 <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@14ae5a5</span> <span class="token punctuation">(</span>筷子<span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
名称<span class="token operator">:</span> 赫拉克利特
状态<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@6d6f6e28</span> <span class="token punctuation">(</span>筷子<span class="token number">5</span><span class="token punctuation">)</span> 上的<span class="token constant">BLOCKED</span><span class="token punctuation">,</span> 拥有者<span class="token operator">:</span> 阿基米德
总阻止数<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> 总等待数<span class="token operator">:</span> <span class="token number">0</span>
堆栈跟踪<span class="token operator">:</span>
<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Philosopher</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestDinner</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">)</span>
 <span class="token operator">-</span> 已锁定 <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span></span>Chopstick</span><span class="token annotation punctuation">@7f31245a</span> <span class="token punctuation">(</span>筷子<span class="token number">4</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>这种线程没有按预期结束，执行不下去的情况，归类为「活跃性」问题，除了死锁以外，还有活锁和饥饿者两种情况。</p> <h3 id="活锁"><a href="#活锁" class="header-anchor">#</a> 活锁</h3> <p>活锁出现在两个线程互相改变对方的结束条件，最后谁也无法结束，例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestLiveLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 期望减到 0 退出循环</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token operator">--</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;count: {}&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 期望超过 20 退出循环</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;count: {}&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>线程 t1 对 count++，线程 t2 对 count--，导致 count 加完就减，减完就加，所以 <strong>一直维持在一定范围内</strong>，导致无法结束运行。</p> <p>解决：<strong>让线程进行 sleep 睡眠</strong>，其睡眠时间不能一致，可以利用 Random 产生随机睡眠时间。</p> <h3 id="饥饿"><a href="#饥饿" class="header-anchor">#</a> 饥饿</h3> <p>饥饿定义：<strong>一个线程由于优先级太低，始终得不到 CPU 调度执行，也不能够结束</strong>，饥饿的情况不易演示，讲读写锁时会涉及饥饿问题。</p> <p>如下图，线程 2 打算获取对象 A 的锁，却被线程 1 获取了，当线程 2 放弃对象 A 的锁，去获取对象 B 的锁，又被线程 1 抢先一步获取，导致线程 2 产生饥饿问题，<strong>即在整个运行过程，都无法获取任何锁</strong>。</p> <p><img src="https://cdn.staticaly.com/gh/Kele-Bingtang/static@master/img/juc/20220512010216.png" alt="image-20220512010215250"></p> <p>可以在 <a href="#%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98">哲学家就餐问题</a> 将就餐测试代码改为如下，就可以看到饥饿问题，即某个哲学家永远无法获取筷子，并且又不会产生死锁或活锁：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Chopstick</span> c1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;苏格拉底&quot;</span><span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;柏拉图&quot;</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;亚里士多德&quot;</span><span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;赫拉克利特&quot;</span><span class="token punctuation">,</span> c4<span class="token punctuation">,</span> c5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;阿基米德&quot;</span><span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>顺序加锁产生饥饿问题的解决方案：在线程 2 尝试获取锁失败后，进入阻塞状态，等待线程 1 释放锁，再去获取。</p> <p><img src="https://cdn.staticaly.com/gh/Kele-Bingtang/static@master/img/juc/20220512010256.png" alt="image-20220512010255785"></p> <p>死锁、活锁和饥饿可以用 <code>java.util.concurrent</code> 包下的 ReentrantLock 类解决，看下面介绍。</p> <h3 id="公平锁非公平锁"><a href="#公平锁非公平锁" class="header-anchor">#</a> 公平锁非公平锁</h3> <p>公平锁：是指多个线程按照申请锁的顺序来获取锁，类似排队打饭，先来后到。</p> <p>非公平锁：是指多个线程获取锁的顺序并不是按照申请锁的顺序，有可能后申请的线程比现申请的线程优先获取锁，在高并发的情况下，有可能会造成优先级反转或者饥饿现象。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 无参</span>
<span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 有参</span>
<span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>并发包中的 ReentrantLock 的创建可以指定构造函数的 boolean 类型来得到公平锁或者非公平锁，默认是非公平锁。</p> <p>公平锁：就是很公平，在并发环境中，每个线程在获取到锁时会先查看此锁维护的等待队列，如果为空，或者当前线程是等待队列的第一个，就占有锁，否则就会加入到等待队列中，以后会按照 FIFO（先进先出）的规则从队列中取到自己。</p> <p>非公平锁：非公平锁比较粗鲁，上来就直接尝试占有锁，如果尝试失败，就会采用类似公平锁那种方式。</p> <p>就 ReentrantLock 而言，通过构造函数指定该锁是否是公平锁，默认是非公平锁。非公平锁的优点 <strong>在于吞吐量比公平锁大</strong>。</p> <p>对于 Synchronized 而言，也是一种非公平锁。</p> <h3 id="可重入锁"><a href="#可重入锁" class="header-anchor">#</a> 可重入锁</h3> <p>可重入锁（也叫递归锁），指的是同一线程外层函数获得锁之后，内层递归函数仍然能获取该锁的代码，在同一个线程在外层方法获取锁的时候，在进入内层方法会自动获取锁，也就是说，线程可以进入任何一个它已经拥有的锁，所同步着的代码块。好比家里进入大门之后，就可以进入里面的房间了。</p> <p>ReentrantLock、Synchronized 就是一个典型的可重入锁。</p> <p><strong>可重入锁最大的作用就是避免死锁</strong>。</p> <p>测试：Synchronized</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Phone</span> phone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// T1 线程在外层获取锁时，也会自动获取里面的锁</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            phone<span class="token punctuation">.</span><span class="token function">sendSMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;T1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            phone<span class="token punctuation">.</span><span class="token function">sendSMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;T2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Phone</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sendSMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; sendSMS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; sendEmail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="自旋锁"><a href="#自旋锁" class="header-anchor">#</a> 自旋锁</h3> <p>自旋锁（spinlock），是指尝试获取锁的线程不会立即阻塞，而是采用循环的方式去尝试获取锁，这样的好处是减少线程上下文切换的消耗，缺点是循环会消耗 CPU。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpinLockDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">// 原子引用线程, 没写参数，引用类型默认为 null</span>
    <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 上锁</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;==&gt;mylock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自旋</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//解锁</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;==&gt;myUnlock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpinLockDemo</span> spinLockDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLockDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            spinLockDemo<span class="token punctuation">.</span><span class="token function">myLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            spinLockDemo<span class="token punctuation">.</span><span class="token function">myUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;T1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            spinLockDemo<span class="token punctuation">.</span><span class="token function">myLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            spinLockDemo<span class="token punctuation">.</span><span class="token function">myUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;T2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h2 id="reentrantlock"><a href="#reentrantlock" class="header-anchor">#</a> ReentrantLock</h2> <p>相对于 synchronized 它具备如下特点：</p> <ul><li>可中断</li> <li>可以设置超时时间</li> <li>可以设置为公平锁</li> <li>支持多个条件变量</li></ul> <p>与 synchronized 一样，都支持可重入</p> <blockquote><p>基本语法</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 获取锁</span>
reentrantLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 临界区</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 释放锁</span>
    reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="可重入"><a href="#可重入" class="header-anchor">#</a> 可重入</h3> <p>可重入是指同一个线程如果首次获得了这把锁，那么因为它是这把锁的拥有者，因此有权利再次反复获取这把锁。</p> <p>如果是不可重入锁，那么第二次获得锁时，自己也会被锁挡住。</p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;execute method1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;execute method2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;execute method3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">17</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">11.862</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestReentrant</span> <span class="token operator">-</span> execute method1 
<span class="token number">17</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">11.865</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestReentrant</span> <span class="token operator">-</span> execute method2 
<span class="token number">17</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">11.865</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestReentrant</span> <span class="token operator">-</span> execute method3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>此时是一个 main 线程，可以看到，第 7 行 main 线程获取了锁，16 行依然获取锁，然后 25 行也可以获取锁，代表可重入。</p> <h3 id="可打断"><a href="#可打断" class="header-anchor">#</a> 可打断</h3> <p>加锁后能被打断的 API 是 <code>lockInterruptibly()</code>，lockInterruptibly 方法和 lock 方法一样能获取锁，但又多出来一个特点：能被打断，即：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>示例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;启动...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;等锁的过程中被打断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;执行打断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">18</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">40.520</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestInterrupt</span> <span class="token operator">-</span> 获得了锁
<span class="token number">18</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">40.524</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestInterrupt</span> <span class="token operator">-</span> 启动<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">41.530</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestInterrupt</span> <span class="token operator">-</span> 执行打断
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>InterruptedException</span> 
 at 
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span>AbstractQueuedSynchronizer</span><span class="token punctuation">.</span><span class="token function">doAcquireInterruptibly</span><span class="token punctuation">(</span><span class="token class-name">AbstractQueuedSynchr</span>
onizer<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">898</span><span class="token punctuation">)</span> 
 at 
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span>AbstractQueuedSynchronizer</span><span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token class-name">AbstractQueuedSynchron</span>
izer<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1222</span><span class="token punctuation">)</span> 
 at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span>ReentrantLock</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token class-name">ReentrantLock</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">335</span><span class="token punctuation">)</span> 
 at <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>n4<span class="token punctuation">.</span>reentrant<span class="token punctuation">.</span></span>TestInterrupt</span><span class="token punctuation">.</span>lambda$main$<span class="token function">0</span><span class="token punctuation">(</span><span class="token class-name">TestInterrupt</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">)</span> 
 at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">41.532</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestInterrupt</span> <span class="token operator">-</span> 等锁的过程中被打断
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>注意如果是不可中断模式，那么即使使用了 interrupt 也不会让等待中断，如 lock 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;启动...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;执行打断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;释放了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">18</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">56.261</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestInterrupt</span> <span class="token operator">-</span> 获得了锁
<span class="token number">18</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">56.265</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestInterrupt</span> <span class="token operator">-</span> 启动<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">57.266</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestInterrupt</span> <span class="token operator">-</span> 执行打断 <span class="token comment">// 这时 t1 并没有被真正打断, 而是仍继续等待锁</span>
<span class="token number">18</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">58.267</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestInterrupt</span> <span class="token operator">-</span> 释放了锁
<span class="token number">18</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">58.267</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestInterrupt</span> <span class="token operator">-</span> 获得了锁
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="锁超时"><a href="#锁超时" class="header-anchor">#</a> 锁超时</h3> <p>线程尝试获取锁时，超出了一定时间，则放弃获取锁。</p> <p>锁超时的 API 为 <code>tryLock()</code>，tryLock 方法会返回一个 boolean 值，如果获取到锁，则返回 true，如果获取不到锁，则返回 false。</p> <p>即：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> isGetLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或者</span>
<span class="token keyword">boolean</span> isGetLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TimeUnit 为时间单位，如秒、分、时，timeout 为时间值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>锁超时又分为两者情况：</p> <blockquote><p>立刻失败</p></blockquote> <p>直接使用 <code>lock.tryLock();</code>，判断返回的 boolean 类型知道是否成功获取锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;启动...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获取立刻失败，返回&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">18</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">02.918</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestTimeout</span> <span class="token operator">-</span> 获得了锁
<span class="token number">18</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">02.921</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestTimeout</span> <span class="token operator">-</span> 启动<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">02.921</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestTimeout</span> <span class="token operator">-</span> 获取立刻失败，返回
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>因为 main 线程先获取锁，2s 才释放锁，而 t1 线程直接尝试获取锁失败，返回 false。</p> <blockquote><p>超时失败</p></blockquote> <p>规定好超时时间，使用 <code>lock.tryLock(long timeout, TimeUnit unit);</code>，判断返回的 boolean 类型知道是否成功获取锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;启动...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获取等待 1s 后失败，返回&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;获得了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">18</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">40.537</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestTimeout</span> <span class="token operator">-</span> 获得了锁
<span class="token number">18</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">40.544</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestTimeout</span> <span class="token operator">-</span> 启动<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">18</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">41.547</span> <span class="token punctuation">[</span>t1<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestTimeout</span> <span class="token operator">-</span> 获取等待 <span class="token number">1</span>s 后失败，返回
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>main 线程先获取锁，然后睡眠 2s 才释放锁，而 t1 线程等待 1s 后无法获取锁，于是就返回 false。</p> <h3 id="使用-trylock-解决哲学家就餐问题"><a href="#使用-trylock-解决哲学家就餐问题" class="header-anchor">#</a> 使用 tryLock 解决哲学家就餐问题</h3> <p>因为筷子类是对象锁，所以直接令筷子类继承 <code>ReentrantLock</code>，这样筷子对象都拥有 <code>ReentrantLock</code> 的 API。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Chopstick</span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;筷子{&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token char">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>哲学家类。当某个哲学家尝试获取左右筷子，如果获取失败，则放下自己手中的筷子给别人使用。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Philosopher</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token class-name">Chopstick</span> left<span class="token punctuation">;</span>
    <span class="token class-name">Chopstick</span> right<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Chopstick</span> left<span class="token punctuation">,</span> <span class="token class-name">Chopstick</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> left<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> right<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 尝试获得左手筷子</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>left<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 尝试获得右手筷子</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>right<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                            right<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    left<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;eating...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Sleeper</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>就餐测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Chopstick</span> c1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Chopstick</span> c5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;苏格拉底&quot;</span><span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;柏拉图&quot;</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;亚里士多德&quot;</span><span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;赫拉克利特&quot;</span><span class="token punctuation">,</span> c4<span class="token punctuation">,</span> c5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;阿基米德&quot;</span><span class="token punctuation">,</span> c5<span class="token punctuation">,</span> c1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="公平锁"><a href="#公平锁" class="header-anchor">#</a> 公平锁</h3> <p>公平锁是为了解决饥饿问题，即让所有线程都 <strong>平均</strong> 的获取锁。</p> <p>如何开启公平锁呢？ReentrantLock 有个构造函数传入 boolean 值，就是是否开启公平锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ReentrantLock 默认是不公平的，即 <code>fair = false</code>。</p> <p>例子：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 1s 之后去争抢锁</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; start...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;强行插入&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>强行插入，有机会在中间输出（注意：该实验不一定总能复现）。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>t39 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t40 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t41 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t42 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t43 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
强行插入 start<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
强行插入 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t44 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t45 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t46 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t47 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t49 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>改为公平锁后：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>强行插入，总是在最后输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>t465 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t464 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t477 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t442 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t468 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t493 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t482 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t485 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
t481 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
强行插入 start<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
强行插入 running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>公平锁一般没有必要，会降低并发度，后面分析原理时会讲解。</p> <h3 id="条件变量"><a href="#条件变量" class="header-anchor">#</a> 条件变量</h3> <p>synchronized 中也有条件变量，就是我们讲原理时那个 waitSet 休息室，当条件不满足时进入 waitSet 等待。</p> <p>ReentrantLock 的条件变量比 synchronized 强大之处在于，它是支持多个条件变量的，这就好比：</p> <ul><li>synchronized 是那些不满足条件的线程都在一间休息室等消息</li> <li>而 ReentrantLock 支持多间休息室，有专门等烟的休息室、专门等早餐的休息室、唤醒时也是按休息室来唤醒</li></ul> <p>使用要点：</p> <ul><li>await 前需要获得锁</li> <li>await 执行后，会释放锁，进入 conditionObject 等待</li> <li>await 的线程被唤醒（或打断、或超时）取重新竞争 lock 锁</li> <li>竞争 lock 锁成功后，从 await 后继续执行</li></ul> <p>如何创建条件变量呢？利用 <code>newCondition()</code>，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Condition</span> c1 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Condition</span> c2 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// c1 等待</span>
c1<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// c2 等待</span>
c2<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 唤醒 c1 的一个随机线程</span>
c1<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 等价于 notify()</span>
<span class="token comment">// 唤醒 c2 所有线程</span>
c2<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等价于 notifyAll()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在哪个线程里使用 <code>c1.await()</code>，则该线程暂停等待，如果需要唤醒，则在其他线程调用 <code>c1.signal()</code> 唤醒 c1 里的一个线程。</p> <p>如果想唤醒 c1 的多个线程，则是 <code>c1.signalAll()</code>。</p> <blockquote><p>注意：c1 是一个空间，类似于休息室，在哪个线程调用 <code>c1.await()</code>，则该线程进入 c1 休息室，要想出来（唤醒），就等待其他线程调用 <code>c1.signal()</code> 或 <code>c1.signalAll()</code>。</p></blockquote> <p>例子：</p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Condition</span> waitCigaretteQueue <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Condition</span> waitbreakfastQueue <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> hasCigrette <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> hasBreakfast <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasCigrette<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 该线程进入 waitCigaretteQueue 里等待</span>
                        waitCigaretteQueue<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;等到了它的烟&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasBreakfast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 该线程进入 waitbreakfastQueue 里等待</span>
                        waitbreakfastQueue<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;等到了它的早餐&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendBreakfast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendCigarette</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendCigarette</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;送烟来了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hasCigrette <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// 唤醒 waitCigaretteQueue 里的一个随机线程</span>
            waitCigaretteQueue<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendBreakfast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;送早餐来了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hasBreakfast <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// 唤醒 waitbreakfastQueue 里的一个随机线程</span>
            waitbreakfastQueue<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">18</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">27.680</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestCondition</span> <span class="token operator">-</span> 送早餐来了
<span class="token number">18</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">27.682</span> <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestCondition</span> <span class="token operator">-</span> 等到了它的早餐
<span class="token number">18</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">28.683</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestCondition</span> <span class="token operator">-</span> 送烟来了
<span class="token number">18</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">28.683</span> <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>TestCondition</span> <span class="token operator">-</span> 等到了它的烟
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="区别"><a href="#区别" class="header-anchor">#</a> 区别</h3> <p>ReentrantLock 和 Synchronized 区别：</p> <ul><li>首先 Synchronized 是 Java 内置关键字，在 JVM 层面，ReentrantLock 是个 Java 类</li> <li>Synchronized 无法判断是否获取锁的状态，ReentrantLock 可以判断是否获取到锁</li> <li>Synchronized 会自动释放锁（a 线程执行完同步代码会释放锁；b 线程执行过程中发生异常会释放锁），ReentrantLock 需在 finally 中手动释放锁（<code>unlock()</code> 方法释放锁），否则容易造成线程死锁</li> <li>用 Synchronized 关键字的两个线程 1 和线程 2，如果当前线程 1 获得锁，线程 2 线程等待。如果线程 1 阻塞，线程 2 则会一直等待下去，而 ReentrantLock 锁就不一定会等待下去，如果尝试获取不到锁，线程可以不用一直等待就结束了</li> <li>Synchronized 的锁可重入、不可中断、非公平，而 ReentrantLock 锁可重入、可判断、可公平（两者皆可）</li> <li>ReentrantLock 锁适合大量同步的代码的同步问题，Synchronized 锁适合代码少量的同步问题</li></ul> <h2 id="同步模式之顺序控制"><a href="#同步模式之顺序控制" class="header-anchor">#</a> 同步模式之顺序控制</h2> <h3 id="固定运行顺序"><a href="#固定运行顺序" class="header-anchor">#</a> 固定运行顺序</h3> <p>比如，必须先打印 2 后再打印 1。</p> <h4 id="wait-notify-版"><a href="#wait-notify-版" class="header-anchor">#</a> wait notify 版</h4> <p>创建一个对象锁和一个 boolean 对象，前者是线程锁，后者是判断先打印 1 还是先打印 2。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用来同步的对象</span>
    <span class="token keyword">static</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// t2 运行标记， 代表 t2 是否执行过</span>
    <span class="token keyword">static</span> <span class="token keyword">boolean</span> t2runed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果 t2 没有执行过</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>t2runed<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// t1 先等一会</span>
                        obj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 修改运行标记</span>
                t2runed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">// 通知 obj 上等待的线程（可能有多个，因此需要用 notifyAll）</span>
                obj<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="park-unpark-版"><a href="#park-unpark-版" class="header-anchor">#</a> Park Unpark 版</h4> <p>可以看到，wait notify 版实现很麻烦：</p> <ul><li>首先，需要保证先 wait 再 notify，否则 wait 线程永远得不到唤醒。因此使用了『运行标记』来判断该不该 wait</li> <li>第二，如果有些干扰线程错误的 notify 了 wait 线程，条件不满足时还要重新等待，使用了 while 循环来解决此问题</li> <li>最后，唤醒对象上的 wait 线程需要使用 notifyAll，因为『同步对象』上的等待线程可能不止一个</li></ul> <p>可以使用 LockSupport 类的 park 和 unpark 来简化上面的题目：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 当没有『许可』时，当前线程暂停运行；有『许可』时，用掉这个『许可』，当前线程恢复运行</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 给线程 t1 发放『许可』（多次连续调用 unpark 只会发放一个『许可』）</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>park 和 unpark 方法比较灵活，他俩谁先调用，谁后调用无所谓。并且是以线程为单位进行『暂停』和『恢复』，不需要『同步对象』和『运行标记』。</p> <h3 id="交替输出"><a href="#交替输出" class="header-anchor">#</a> 交替输出</h3> <p>线程 1 输出 a 共 5 次，线程 2 输出 b 共 5 次，线程 3 输出 c 共 5 次。现在要求输出 abcabcabcabcabc 怎么实现？</p> <h4 id="wait-notify-版-2"><a href="#wait-notify-版-2" class="header-anchor">#</a> wait notify 版</h4> <p>利用 flag 来说存放当前线程。</p> <p>写一个 print 方法，有三个参数：str 是打印的信息，curFlag 是当前线程，nextFlag 是下一个执行的线程。</p> <p>当传过来的当前线程等于 flag，则打印该当前线程携带的信息，接着 curFlag 等于下一个执行的线程 nextFlag，然后唤醒所有线程，只有满足 <code>nextFlag == falg</code> 才打印携带的信息，其他线程虽然被唤醒，但是没有跳出 while 循环，继续 wait 等待。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">SyncWaitNotify</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1 代表打印 a，2 代表打印 b，3 代表打印 c</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> flag<span class="token punctuation">;</span>
    <span class="token comment">// 循环次数</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> loopNumber<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">SyncWaitNotify</span><span class="token punctuation">(</span><span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span> loopNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> flag<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loopNumber <span class="token operator">=</span> loopNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// curFlag：当前线程，nextFlag：下一个执行的线程，str：打印的信息</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">,</span> <span class="token keyword">int</span> curFlag<span class="token punctuation">,</span> <span class="token keyword">int</span> nextFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> loopNumber<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">!=</span> curFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
                flag <span class="token operator">=</span> nextFlag<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化 1 打印，循环 5 次</span>
        <span class="token class-name">SyncWaitNotify</span> syncWaitNotify <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaitNotify</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            syncWaitNotify<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            syncWaitNotify<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            syncWaitNotify<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h4 id="lock-条件变量版"><a href="#lock-条件变量版" class="header-anchor">#</a> Lock 条件变量版</h4> <p>利用到了 ReentrantLock 的条件变量 Condition。</p> <p>写一个 print 方法，有三个参数：str 是打印的信息，current 是当前条件变量，next 是下一个执行条件变量。</p> <p>先让所有条件变量 <code>current.wait()</code> 等待，然后唤醒一个当前条件变量，该条件变量携带的信息打印后，唤醒下一个条件变量，打印下一个条件变量携带的信息，依次类推。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">AwaitSignal</span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">Condition</span> first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            first<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">,</span> <span class="token class-name">Condition</span> current<span class="token punctuation">,</span> <span class="token class-name">Condition</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> loopNumber<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 当前线程等待</span>
                current<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果等待结束，则打印 str</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 唤醒下一个线程</span>
                next<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 循环次数</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> loopNumber<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">AwaitSignal</span><span class="token punctuation">(</span><span class="token keyword">int</span> loopNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loopNumber <span class="token operator">=</span> loopNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AwaitSignal</span> as <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AwaitSignal</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Condition</span> aWaitSet <span class="token operator">=</span> as<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Condition</span> bWaitSet <span class="token operator">=</span> as<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Condition</span> cWaitSet <span class="token operator">=</span> as<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            as<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> aWaitSet<span class="token punctuation">,</span> bWaitSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            as<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> bWaitSet<span class="token punctuation">,</span> cWaitSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            as<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> cWaitSet<span class="token punctuation">,</span> aWaitSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化 aWaitSet 条件变量打印</span>
        as<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>aWaitSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><blockquote><p>注意：该实现没有考虑 a，b，c 线程都就绪再开始。</p></blockquote> <h4 id="park-unpark-版-2"><a href="#park-unpark-版-2" class="header-anchor">#</a> Park Unpark 版</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">SyncPark</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> loopNumber<span class="token punctuation">;</span>
    <span class="token comment">// 线程的集合数组</span>
    <span class="token keyword">private</span> <span class="token class-name">Thread</span><span class="token punctuation">[</span><span class="token punctuation">]</span> threads<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">SyncPark</span><span class="token punctuation">(</span><span class="token keyword">int</span> loopNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loopNumber <span class="token operator">=</span> loopNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setThreads</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threads <span class="token operator">=</span> threads<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> loopNumber<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 暂停当前线程</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 暂停结束后打印信息</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 唤醒下一个线程</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span><span class="token function">nextThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Thread</span> <span class="token function">nextThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取当前线程</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取 threads 里的线程位置</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                index <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回下一个线程（当前线程位置 + 1）</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">&lt;</span> threads<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> threads<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> threads<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span> thread <span class="token operator">:</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 初始化d</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>threads<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SyncPark</span> syncPark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncPark</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            syncPark<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            syncPark<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            syncPark<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;c\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        syncPark<span class="token punctuation">.</span><span class="token function">setThreads</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> t2<span class="token punctuation">,</span> t3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        syncPark<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/mijingduI/mijingdui.github.io/edit/master/docs/10.Java/10.Java并发 - JUC/10.JUC - 共享模式之锁进阶.md" target="_blank" rel="noopener noreferrer">编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=JUC" title="标签">#JUC</a></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2023/07/04, 03:31:55</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/java/juc/lock-basics/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">JUC - 共享模式之锁基础</div></a> <a href="/java/juc/memory/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">JUC - 共享模式之内存</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/java/juc/lock-basics/" class="prev">JUC - 共享模式之锁基础</a></span> <span class="next"><a href="/java/juc/memory/">JUC - 共享模式之内存</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/about/learn-line/"><div>
            自我 - 学习线
            <span class="title-tag">
              原创
            </span></div></a> <span class="date">07-05</span></dt></dl><dl><dd>02</dd> <dt><a href="/about/me/introduce/"><div>
            自我 - 介绍
            <span class="title-tag">
              原创
            </span></div></a> <span class="date"></span></dt></dl><dl><dd>03</dd> <dt><a href="/git/commit-dev/"><div>
            Git - Commit 开发规范
            <!----></div></a> <span class="date"></span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/mijingduI" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/mijingduI" title="Gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://mijingdui.github.io/" title="网站首页" target="_blank" class="iconfont icon-rss"></a><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=727539981&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" class="iconfont icon-QQ"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>阿星  | blog<br> <a href="https://github.com/mijingduI/mijingdui.github.io/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div><div></div></div></div>
    <script src="/assets/js/app.e9152798.js" defer></script><script src="/assets/js/2.38a2c275.js" defer></script><script src="/assets/js/84.e2702905.js" defer></script><script src="/assets/js/7.c9d16a87.js" defer></script><script src="/assets/js/4.d198576f.js" defer></script>
  </body>
</html>
